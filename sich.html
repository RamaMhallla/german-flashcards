<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± ÙˆØ§Ù„Ù…Ù„ÙƒÙŠØ© Ùˆ sich â€” ØªØ¯Ø±ÙŠØ¨ ØªÙØ§Ø¹Ù„ÙŠ</title>

    <!-- Tajawal -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #f43f5e;
        --primary-light: #fb7185;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --light-bg: #f9fafb;
        --card-bg: #fff;
        --text: #1f2937;
        --text-light: #6b7280;
        --border: #e5e7eb;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --sidebar-w: 280px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Tajawal", sans-serif;
        min-height: 100vh;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      }

      .topbar {
        display: none;
        position: sticky;
        top: 0;
        z-index: 30;
        background: #fff;
        border-bottom: 1px solid var(--border);
        padding: 10px 14px;
      }
      .hamburger {
        all: unset;
        cursor: pointer;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
      }

      .layout {
        display: grid;
        grid-template-columns: var(--sidebar-w) 1fr;
        min-height: 100vh;
      }

      #sidebar {
        background: #fff;
        border-inline-end: 1px solid var(--border);
        position: sticky;
        top: 0;
        height: 100vh;
        overflow: auto;
        box-shadow: var(--shadow);
        z-index: 20;
      }
      #sidebar.as-overlay {
        position: fixed;
        inset-inline-start: 0;
        top: 52px;
        bottom: 0;
        width: 80vw;
        max-width: 320px;
        transform: translateX(110%);
        transition: transform 0.2s ease;
        border-inline-end: 1px solid var(--border);
        display: block;
      }
      #sidebar.as-overlay.open {
        transform: translateX(0);
      }

      main.content {
        padding: 24px;
      }
      .app {
        width: min(980px, 100%);
        margin: auto;
      }

      /* Sidebar inner (optional if you have sidebar.html) */
      #sidebar .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
        padding: 4px 2px;
      }
      #sidebar .logo {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        background: linear-gradient(
          135deg,
          var(--primary-light),
          var(--primary)
        );
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 700;
        box-shadow: 0 6px 14px rgba(244, 63, 94, 0.25);
      }
      #sidebar .brand h2 {
        font-size: 18px;
        margin: 0;
        color: var(--text);
      }
      #sidebar .muted {
        color: var(--text-light);
        font-size: 13px;
      }

      #sidebar nav.nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }
      #sidebar .section {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
      }
      #sidebar .section + .section {
        margin-top: 10px;
      }
      #sidebar .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        cursor: pointer;
        user-select: none;
      }
      #sidebar .section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        color: var(--primary);
      }
      #sidebar .chev {
        transition: transform 0.2s ease;
      }
      #sidebar .section[aria-expanded="true"] .chev {
        transform: rotate(180deg);
      }
      #sidebar .section-body {
        display: none;
        border-top: 1px solid var(--border);
      }
      #sidebar .section[aria-expanded="true"] .section-body {
        display: block;
      }
      #sidebar .submenu {
        padding: 10px;
      }

      #sidebar .slink {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-radius: 10px;
        text-decoration: none;
        color: var(--text);
        transition: 0.15s;
        border: 1px solid transparent;
      }
      #sidebar .slink:hover {
        background: #f8fafc;
        border-color: var(--border);
      }
      #sidebar .slink.active {
        background: #fff1f2;
        border-color: #fecdd3;
      }
      #sidebar .chip {
        font-size: 12px;
        background: #ffe4e6;
        color: var(--primary);
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid #fecdd3;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }
      h1 {
        font-size: clamp(24px, 3.4vw, 36px);
        margin: 0;
        line-height: 1.3;
        color: var(--primary);
        font-weight: 700;
      }
      .subtitle {
        color: var(--text-light);
        font-size: clamp(14px, 1.6vw, 17px);
        margin-top: 8px;
        max-width: 720px;
      }
      .pill {
        background: #f1f5f9;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 13px;
        color: var(--primary);
        font-weight: 600;
      }

      .card {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: var(--shadow);
        padding: 24px;
        border: 1px solid var(--border);
      }

      .progress {
        height: 12px;
        background: #f3f4f6;
        border-radius: 999px;
        overflow: hidden;
        margin: 14px 0 18px;
      }
      .progress > span {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(
          90deg,
          var(--primary-light),
          var(--primary)
        );
        transition: width 0.4s ease;
      }

      .q-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        color: var(--text-light);
        margin-bottom: 14px;
      }
      .q-index {
        padding: 6px 14px;
        border-radius: 999px;
        background: #f1f5f9;
        color: var(--primary);
        font-weight: 700;
        font-size: 14px;
      }
      .q-type {
        font-size: 14px;
        color: var(--primary);
        background: #fff1f2;
        padding: 4px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
      }
      .prompt {
        font-size: clamp(18px, 2.7vw, 24px);
        line-height: 1.6;
        margin: 10px 0 18px;
        color: var(--text);
      }
      .de {
        direction: ltr;
        unicode-bidi: plaintext;
        background: #f8fafc;
        padding: 4px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        display: inline-block;
        font-family: monospace;
        font-size: 0.95em;
      }

      .choices {
        display: grid;
        gap: 12px;
      }
      .choice {
        padding: 16px 18px;
        border-radius: 14px;
        background: #f8fafc;
        border: 2px solid var(--border);
        cursor: pointer;
        transition: 0.2s;
        font-weight: 500;
        text-align: right;
      }
      .choice:hover {
        border-color: var(--primary-light);
        background: #fff1f2;
      }
      .choice.selected {
        border-color: var(--primary);
        background: #ffe4e6;
      }
      .choice.correct {
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.1);
      }
      .choice.wrong {
        border-color: var(--danger);
        background: rgba(239, 68, 68, 0.1);
      }

      .gap-line {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin: 10px 0;
      }
      select.gap {
        padding: 10px 14px;
        border-radius: 10px;
        background: #f8fafc;
        color: var(--text);
        border: 2px solid var(--border);
        min-width: 120px;
      }

      .actions {
        display: flex;
        gap: 12px;
        margin-top: 18px;
        flex-wrap: wrap;
      }
      button {
        all: unset;
        padding: 12px 18px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .primary {
        background: linear-gradient(
          90deg,
          var(--primary),
          var(--primary-light)
        );
        color: #fff;
      }
      .ghost {
        border: 2px solid var(--border);
        background: #fff;
        color: var(--text);
      }

      .feedback {
        margin-top: 16px;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid;
      }
      .ok {
        background: rgba(16, 185, 129, 0.1);
        border-color: var(--success);
        color: #065f46;
      }
      .bad {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--danger);
        color: #991b1b;
      }
      .tip {
        background: rgba(245, 158, 11, 0.1);
        border-color: var(--warning);
        color: #92400e;
      }

      .section-list {
        display: grid;
        gap: 14px;
        margin-bottom: 18px;
      }
      .sec-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border: 1px solid var(--border);
        border-radius: 14px;
        background: #fff;
      }
      .sec-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .sec-title {
        font-weight: 800;
        color: var(--primary);
      }
      .sec-meta {
        font-size: 13px;
        color: var(--text-light);
      }
      .start-btn {
        all: unset;
        background: linear-gradient(
          90deg,
          var(--primary),
          var(--primary-light)
        );
        color: #fff;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
      }

      .type-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: center;
      }
      .type-input {
        padding: 12px 14px;
        border: 2px solid var(--border);
        border-radius: 12px;
        min-width: 280px;
        font-family: inherit;
        font-size: 16px;
        background: #fff;
        direction: ltr;
      }
      .type-input:focus {
        outline: none;
        border-color: var(--primary);
      }
      .type-input.ok {
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.08);
      }
      .type-input.bad {
        border-color: var(--danger);
        background: rgba(239, 68, 68, 0.08);
      }
      .hint {
        color: var(--text-light);
        font-size: 13px;
        margin-top: 6px;
        text-align: center;
      }

      .cheat-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      .cheat-table th,
      .cheat-table td {
        border: 1px solid var(--border);
        padding: 8px 10px;
        text-align: center;
      }
      .cheat-table th {
        background: #fafafa;
      }

      @media (max-width: 900px) {
        .topbar {
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .layout {
          grid-template-columns: 1fr;
        }
        #sidebar {
          display: none;
        }
        #sidebar.as-overlay {
          display: block;
        }
        main.content {
          padding: 16px;
        }
      }
    </style>
  </head>

  <body>
    <!-- Top bar Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
    <div class="topbar">
      <button class="hamburger" id="menuBtn">â˜°</button>
      <strong>Pronouns & Possessives & sich</strong>
    </div>

    <div class="layout">
      <div id="sidebar"></div>

      <main class="content">
        <div class="app">
          <div class="header">
            <div>
              <h1>
                Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± ÙˆØ§Ù„Ù…Ù„ÙƒÙŠØ© Ùˆ
                <span style="color: var(--primary-light)">sich</span>
              </h1>
              <div class="subtitle">
                Ø¯Ø±Ù‘Ø¨ Ù†ÙØ³Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ø´Ø®ØµÙŠØ© (NOM/AKK/DAT)ØŒ Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³ÙŠØ©
                (sich)ØŒ ÙˆØ¶Ù…Ø§Ø¦Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ù…Ø¹ Ù†Ù‡Ø§ÙŠØ§ØªÙ‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù†ÙˆØ¹. ÙƒÙ„ Ù‚Ø³Ù… ÙÙŠÙ‡
                Ø£Ø³Ø¦Ù„Ø© Ø¨Ø£Ù†Ù…Ø§Ø· Ù…Ø®ØªÙ„ÙØ©.
              </div>
            </div>
            <div class="pill" id="globalScore">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: 0 / 0</div>
          </div>

          <!-- Ø£Ù‚Ø³Ø§Ù… -->
          <div class="card" id="sectionsCard">
            <div class="section-list" id="secList"></div>
          </div>

          <!-- ÙƒÙˆÙŠØ² Ù†Ø´Ø· -->
          <div class="card" id="quizCard" style="display: none">
            <div class="q-meta">
              <div class="q-index" id="qIndex">Ø³Ø¤Ø§Ù„ 1 / ?</div>
              <div class="q-type" id="qType"></div>
            </div>
            <div class="progress"><span id="bar"></span></div>
            <div class="prompt" id="prompt"></div>
            <div id="content"></div>
            <div class="actions">
              <button class="primary" id="checkBtn">ØªØ­Ù‚Ù‘Ù‚</button>
              <button class="ghost" id="nextBtn" disabled>Ø§Ù„ØªØ§Ù„ÙŠ âŸµ</button>
              <button class="ghost" id="exitBtn">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù…</button>
            </div>
            <div id="feedback"></div>
            <div class="pill" id="catPill" style="margin-top: 10px">â€”</div>
          </div>

          <!-- Cheatsheet -->
          <details class="card" style="margin-top: 18px">
            <summary
              style="cursor: pointer; color: var(--primary); font-weight: 700"
            >
              ğŸ“’ Ù…Ø±Ø¬Ø¹ Ø³Ø±ÙŠØ¹ (Cheatsheet)
            </summary>

            <h3 style="margin-top: 12px">Ù¡) Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
            <table class="cheat-table">
              <tr>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ich</th>
                <th>Du</th>
                <th>Er</th>
                <th>Sie</th>
                <th>Es</th>
                <th>Wir</th>
                <th>Ihr</th>
                <th>sie</th>
                <th>Sie</th>
              </tr>
              <tr>
                <td>Nominativ</td>
                <td>ich</td>
                <td>du</td>
                <td>er</td>
                <td>sie</td>
                <td>es</td>
                <td>wir</td>
                <td>ihr</td>
                <td>sie</td>
                <td>Sie</td>
              </tr>
              <tr>
                <td>Akkusativ</td>
                <td>mich</td>
                <td>dich</td>
                <td>ihn</td>
                <td>sie</td>
                <td>es</td>
                <td>uns</td>
                <td>euch</td>
                <td>sie</td>
                <td>Sie</td>
              </tr>
              <tr>
                <td>Dativ</td>
                <td>mir</td>
                <td>dir</td>
                <td>ihm</td>
                <td>ihr</td>
                <td>ihm</td>
                <td>uns</td>
                <td>euch</td>
                <td>ihnen</td>
                <td>Ihnen</td>
              </tr>
            </table>

            <h3 style="margin-top: 12px">Ù¢) Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³ÙŠØ© (sich)</h3>
            <table class="cheat-table">
              <tr>
                <th>Ø§Ù„Ø´Ø®Øµ</th>
                <th>Akk</th>
                <th>Dat</th>
              </tr>
              <tr>
                <td>ich</td>
                <td>mich</td>
                <td>mir</td>
              </tr>
              <tr>
                <td>du</td>
                <td>dich</td>
                <td>dir</td>
              </tr>
              <tr>
                <td>er/sie/es</td>
                <td>sich</td>
                <td>sich</td>
              </tr>
              <tr>
                <td>wir</td>
                <td>uns</td>
                <td>uns</td>
              </tr>
              <tr>
                <td>ihr</td>
                <td>euch</td>
                <td>euch</td>
              </tr>
              <tr>
                <td>sie/Sie</td>
                <td>sich</td>
                <td>sich</td>
              </tr>
            </table>
            <p style="margin-top: 8px; color: var(--text-light)">
              Ù…Ø«Ø§Ù„:
              <span class="de"
                >Ich wasche <b>mich</b>. Â· Ich wasche <b>mir</b> die
                HÃ¤nde.</span
              >
            </p>

            <h3 style="margin-top: 12px">
              Ù£) Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ© (ÙƒØ£Ø¯ÙˆØ§Øª ein-words)
            </h3>
            <p style="color: var(--text-light)">
              Ø§Ù„Ø£Ø³Ø§Ø³: mein, dein, sein, ihr, sein, unser, euer, ihr, Ihr
            </p>
            <table class="cheat-table">
              <tr>
                <th></th>
                <th>Ù…Ø°ÙƒØ±</th>
                <th>Ù…Ø¤Ù†Ø«</th>
                <th>Ø­ÙŠØ§Ø¯ÙŠ</th>
                <th>Ø¬Ù…Ø¹</th>
              </tr>
              <tr>
                <td>Nominativ</td>
                <td>-</td>
                <td>-e</td>
                <td>-</td>
                <td>-e</td>
              </tr>
              <tr>
                <td>Akkusativ</td>
                <td>-en</td>
                <td>-e</td>
                <td>-</td>
                <td>-e</td>
              </tr>
              <tr>
                <td>Dativ</td>
                <td>-em</td>
                <td>-er</td>
                <td>-em</td>
                <td>-en (ÙˆÙŠÙØ¶Ø§Ù -n Ù„Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ù…Ø¹ ØºØ§Ù„Ø¨Ù‹Ø§)</td>
              </tr>
            </table>
            <p style="margin-top: 8px; color: var(--text-light)">
              Ù…Ù„Ø§Ø­Ø¸Ø©: <b>euer</b> Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ØªØ³Ù‚Ø· Ø§Ù„Ù€ <b>e</b> Ø§Ù„ÙˆØ³Ø·Ù‰:
              <span class="de">eure, euren, eurem, eurer</span>.
            </p>
          </details>
        </div>
      </main>
    </div>

    <script>
      /* ==== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ==== */
      function arraysEqual(a, b) {
        return (
          Array.isArray(a) &&
          Array.isArray(b) &&
          a.length === b.length &&
          a.every((v, i) => v === b[i])
        );
      }
      function normalizeText(s) {
        return String(s || "")
          .toLowerCase()
          .replace(/[ØŸ?!.]+$/, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      /* ==== Sidebar (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ sidebar.html) ==== */
      const sidebarHost = document.getElementById("sidebar");
      const menuBtn = document.getElementById("menuBtn");

      function applySidebarMode() {
        const isMobile = window.matchMedia("(max-width: 900px)").matches;
        if (isMobile) {
          sidebarHost.classList.add("as-overlay");
        } else {
          sidebarHost.classList.remove("as-overlay", "open");
          sidebarHost.style.display = "";
        }
      }

      async function loadSidebar() {
        try {
          const res = await fetch("sidebar.html", { cache: "no-cache" });
          if (!res.ok) throw new Error(res.status + " " + res.statusText);
          const html = await res.text();
          sidebarHost.innerHTML = html;

          sidebarHost.querySelectorAll(".section-header").forEach((h) => {
            h.addEventListener("click", () => {
              const s = h.closest(".section");
              if (s) s.toggleAttribute("aria-expanded");
            });
          });

          const current = location.pathname.split("/").pop() || "index.html";
          sidebarHost.querySelectorAll(".slink").forEach((a) => {
            if (a.getAttribute("href") === current) a.classList.add("active");
          });

          applySidebarMode();
        } catch (e) {
          console.warn("Sidebar load failed, showing fallback");
          sidebarHost.innerHTML = `
            <aside style="padding:16px">
              <div style="color:#991b1b;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:10px">
                ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ <b>sidebar.html</b>. Ø´ØºÙ‘Ù„ Ø¹Ø¨Ø± Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ (Live Server) Ø£Ùˆ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±.
              </div>
              <nav class="nav" style="margin-top:10px">
                <div class="section" aria-expanded="true">
                  <div class="section-header">
                    <div class="section-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
                    <span class="chev">âŒ„</span>
                  </div>
                  <div class="section-body">
                    <div class="submenu">
                      <a class="slink active" href="#">Pronouns &amp; Possessives</a>
                    </div>
                  </div>
                </div>
              </nav>
            </aside>`;
          applySidebarMode();
        }
      }

      if (menuBtn) {
        menuBtn.addEventListener("click", () => {
          if (sidebarHost.classList.contains("as-overlay")) {
            sidebarHost.classList.toggle("open");
          }
        });
      }
      document.addEventListener("click", (e) => {
        if (
          sidebarHost.classList.contains("as-overlay") &&
          sidebarHost.classList.contains("open")
        ) {
          const inside = e.target.closest("#sidebar, #menuBtn");
          if (!inside) sidebarHost.classList.remove("open");
        }
      });
      window.addEventListener("resize", applySidebarMode);
      loadSidebar();

      /* ==== Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ==== */
      const QUESTIONS = [
        /*** A) Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ø´Ø®ØµÙŠØ© NOM/AKK/DAT ***/
        // MC
        {
          type: "mc",
          cat: "Ø¶Ù…Ø§Ø¦Ø± â€” Akk",
          prompt: `Ø§Ø®ØªØ± Ø¶Ù…ÙŠØ± Ø§Ù„Ù…ÙØ¹ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù€ <span class="de">ich</span>:`,
          choices: ["mir", "mich", "ich"],
          answer: 1,
          explain: "Akkusativ Ù„Ù€ ich â†’ mich.",
        },
        {
          type: "mc",
          cat: "Ø¶Ù…Ø§Ø¦Ø± â€” Dat",
          prompt: `Ø§Ø®ØªØ± Ø¶Ù…ÙŠØ± Ø§Ù„Ø¯Ø§ØªÙÙ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù€ <span class="de">du</span>:`,
          choices: ["dir", "dich", "du"],
          answer: 0,
          explain: "Dativ Ù„Ù€ du â†’ dir.",
        },
        {
          type: "mc",
          cat: "Ø¶Ù…Ø§Ø¦Ø± â€” Akk",
          prompt: `Ø£ÙƒÙ…Ù„: <span class="de">Kennst du Max? â€” Ja, ich kenne ___.</span>`,
          choices: ["er", "ihm", "ihn"],
          answer: 2,
          explain: "Akk Ù„Ù€ er â†’ ihn.",
        },
        {
          type: "mc",
          cat: "Ø¶Ù…Ø§Ø¦Ø± â€” Dat",
          prompt: `Ø£ÙƒÙ…Ù„: <span class="de">Ich helfe ___ (sie).</span>`,
          choices: ["sie", "ihr", "ihnen"],
          answer: 1,
          explain: "helfen ÙŠØ£Ø®Ø° Dativ: sie (Ù‡ÙŠ) â†’ ihr.",
        },

        // MULTI
        {
          type: "multi",
          cat: "ØªØµÙ†ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø§Øª",
          prompt: `Ø§Ø®ØªØ± ÙƒÙ„ Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ù€ <b>Akkusativ</b>:`,
          choices: ["mich", "dich", "ihm", "sie", "uns", "euch", "ihnen"],
          answers: [0, 1, 3, 4, 5],
          explain:
            "Akk: mich, dich, ihn, sie, es, uns, euch, sie/Sie. (ihm/ihnen = Dativ)",
        },
        {
          type: "multi",
          cat: "ØªØµÙ†ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø§Øª",
          prompt: `Ø§Ø®ØªØ± ÙƒÙ„ Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ù€ <b>Dativ</b>:`,
          choices: ["mir", "dir", "ihn", "ihr", "uns", "euch", "ihm"],
          answers: [0, 1, 3, 4, 5, 6],
          explain: "Dat: mir, dir, ihm, ihr, uns, euch, ihnen/Ihnen.",
        },

        // GAP
        {
          type: "gap",
          cat: "Wen/Was/ wem",
          prompt: `Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¯Ø§Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:`,
          segments: ['<span class="de">___ hilfst du?</span>'],
          options: [["Wen", "Was", "Wem"]],
          answer: [2],
          explain: "Ù…Ø¹ Dativ Ù†Ø³ØªØ®Ø¯Ù… <b>Wem</b> Ù„Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø´Ø®Øµ.",
        },
        {
          type: "gap",
          cat: "ØªØ­ÙˆÙŠÙ„Ø§Øª Ø¶Ù…Ø§Ø¦Ø±",
          prompt: `Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ Akkusativ (Ø¶Ù…ÙŠØ±):`,
          segments: ['<span class="de">Ich sehe ', " (du).</span>"],
          options: [["dir", "dich", "du"]],
          answer: [1],
          explain: "du ÙÙŠ Akk â†’ dich.",
        },

        // TYPE
        {
          type: "type",
          cat: "ÙƒØªØ§Ø¨Ø© â€” Akk",
          prompt: `Ø§ÙƒØªØ¨ Ø¶Ù…ÙŠØ± Akkusativ Ù„Ù€ <span class="de">wir</span>:`,
          answersText: ["uns"],
          explain: "wir â†’ uns (Akk).",
        },
        {
          type: "type",
          cat: "ÙƒØªØ§Ø¨Ø© â€” Dat",
          prompt: `Ø§ÙƒØªØ¨ Ø¶Ù…ÙŠØ± Dativ Ù„Ù€ <span class="de">sie (Ù‡Ù…)</span>:`,
          answersText: ["ihnen"],
          explain: "sie (Ø¬Ù…Ø¹) ÙÙŠ Dat â†’ ihnen.",
        },

        /*** B) Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³ÙŠØ© (sich) ***/
        // MC
        {
          type: "mc",
          cat: "Reflexiv â€” Akk",
          prompt: `Ø§ÙƒÙ…Ù„: <span class="de">Ich wasche ___.</span>`,
          choices: ["mir", "mich", "sich"],
          answer: 1,
          explain: "Ø§Ù†Ø¹ÙƒØ§Ø³ÙŠ Ù…Ø¹ ich ÙÙŠ Akk â†’ mich.",
        },
        {
          type: "mc",
          cat: "Reflexiv â€” Dat",
          prompt: `Ø§ÙƒÙ…Ù„: <span class="de">Ich wasche ___ die HÃ¤nde.</span>`,
          choices: ["mir", "mich", "sich"],
          answer: 0,
          explain: "Ù…Ø¹ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¬Ø³Ø¯ ÙŠØ£ØªÙŠ ØºØ§Ù„Ø¨Ù‹Ø§ Dativ Ø§Ù†Ø¹ÙƒØ§Ø³ÙŠ: mir.",
        },
        {
          type: "mc",
          cat: "Reflexiv â€” 3. Ø´Ø®Øµ",
          prompt: `Ø§ÙƒÙ…Ù„: <span class="de">Er freut ___.</span>`,
          choices: ["sich", "ihm", "ihn"],
          answer: 0,
          explain: "Ø§Ù„ÙØ¹Ù„ freut sich: Ù‡Ùˆ ÙŠÙØ±Ø­ â€” sich.",
        },

        // MULTI
        {
          type: "multi",
          cat: "Reflexiv â€” Akk (Ø§Ø®ØªÙØ± Ø§Ù„ÙƒÙ„)",
          prompt: `Ø§Ø®ØªÙØ± ÙƒÙ„ Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³ ÙÙŠ <b>Akk</b>:`,
          choices: ["mich", "dich", "sich", "uns", "euch", "ihnen"],
          answers: [0, 1, 2, 3, 4],
          explain:
            "Akk reflexiv: mich, dich, sich, uns, euch, sich. (ihnen Ù„ÙŠØ³ Reflexiv).",
        },

        // GAP
        {
          type: "gap",
          cat: "Reflexiv â€” Dat",
          prompt: `Ø£ÙƒÙ…Ù„:`,
          segments: ['<span class="de">Wir kÃ¤mmen ', " die Haare.</span>"],
          options: [["uns", "unsere", "euch"]],
          answer: [0],
          explain: "Ù†Ø³ØªØ®Ø¯Ù… Dativ reflexiv: uns (Ù†Ø­Ù† Ù†Ù…Ø´Ù‘Ø· Ù„Ø£Ù†ÙØ³Ù†Ø§ Ø§Ù„Ø´Ø¹Ø±).",
        },

        // TYPE
        {
          type: "type",
          cat: "Reflexiv â€” ÙƒØªØ§Ø¨Ø©",
          prompt: `Ø§ÙƒØªØ¨ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØµØ­ÙŠØ­: <span class="de">Ihr beeilt ___.</span>`,
          answersText: ["euch"],
          explain: "ihr â†’ euch (Akk/Dat reflexiv).",
        },

        /*** C) Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ© + Ø§Ù„Ù†Ù‡Ø§ÙŠØ§Øª ***/
        // MC
        {
          type: "mc",
          cat: "Ù…Ù„ÙƒÙŠØ© â€” Nominativ",
          prompt: `Ø§Ø®ØªØ± Ø§Ù„ØµØ­ÙŠØ­ (NOM Ù…Ø¤Ù†Ø«): <span class="de">Das ist ___ Tasche (ich).</span>`,
          choices: ["mein Tasche", "meine Tasche", "meiner Tasche"],
          answer: 1,
          explain: "Ù…Ø¤Ù†Ø« ÙÙŠ NOM â†’ -e: meine Tasche.",
        },
        {
          type: "mc",
          cat: "Ù…Ù„ÙƒÙŠØ© â€” Akkusativ",
          prompt: `Ø§Ø®ØªØ± Ø§Ù„ØµØ­ÙŠØ­ (AKK Ù…Ø°ÙƒØ±): <span class="de">Ich habe ___ Stift (du).</span>`,
          choices: ["dein Stift", "deinen Stift", "deinem Stift"],
          answer: 1,
          explain: "Ù…Ø°ÙƒØ± ÙÙŠ AKK â†’ -en: deinen Stift.",
        },
        {
          type: "mc",
          cat: "Ù…Ù„ÙƒÙŠØ© â€” Dativ",
          prompt: `Ø§Ø®ØªØ± Ø§Ù„ØµØ­ÙŠØ­ (DAT Ø¬Ù…Ø¹): <span class="de">Ich helfe ___ Kindern (wir).</span>`,
          choices: ["unsere", "unseren", "unserem"],
          answer: 1,
          explain: "Ø¬Ù…Ø¹ ÙÙŠ DAT â†’ -en + ØºØ§Ù„Ø¨Ù‹Ø§ ÙŠØ¶Ø§Ù -n Ù„Ù„Ø§Ø³Ù…: unseren Kindern.",
        },
        {
          type: "mc",
          cat: "euer â€” Ù‚Ø§Ø¹Ø¯Ø©",
          prompt: `Ø§Ø®ØªØ± Ø§Ù„ØµØ­ÙŠØ­: <span class="de">Ist das ___ Auto? (ihr)</span> <span class="mini-note">(NOM Ø­ÙŠØ§Ø¯ÙŠ)</span>`,
          choices: ["euer Auto", "eures Auto", "eure Auto"],
          answer: 0,
          explain: "NOM Ø­ÙŠØ§Ø¯ÙŠ ÙŠØ£Ø®Ø° Ù†Ù‡Ø§ÙŠØ© ØµÙØ±: euer Auto.",
        },

        // MULTI
        {
          type: "multi",
          cat: "Ø§Ø®ØªÙØ± Ø§Ù„Ù†Ù‡Ø§ÙŠØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©",
          prompt: `Ù„Ù€ (sein) Ø§Ø®ØªØ± ÙƒÙ„ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„ØµØ­ÙŠØ­Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©:`,
          choices: [
            "sein<b>e</b> Lampe (Nom, f)",
            "sein<b>en</b> Bruder (Akk, m)",
            "sein<b>e</b> Kinder (Nom, Pl)",
            "sein<b>em</b> Vater (Dat, m)",
            "sein<b>e</b> Buch (Akk, n)",
          ],
          answers: [0, 1, 2, 3, 4],
          explain:
            "Ù†Ù‡Ø§ÙŠØ§Øª ein-words Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©: f/pl: -e (Nom/Akk), m Akk: -en, m/n Dat: -em, n Nom/Akk: -âˆ… (Ù„ÙƒÙ† Ù‡Ù†Ø§ ÙƒØªØ¨Ù†Ø§ 'sein<b>e</b> Buch'ØŸ Ø®Ø·Ø£! Ø§Ù„Ù†ÙŠÙˆØªØ± ÙÙŠ AKK ÙŠÙƒÙˆÙ† Ø¨Ø¯ÙˆÙ† Ù†Ù‡Ø§ÙŠØ©: 'sein Buch').",
        },

        // Ø³Ù†ØµØ­Ù‘Ø­: Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø®Ø§Ù…Ø³ Ø®Ø·Ø£
        {
          type: "multi",
          cat: "Ø§Ø®ØªÙØ± Ø§Ù„Ù†Ù‡Ø§ÙŠØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© (ØªØµØ­ÙŠØ­)",
          prompt: `Ù„Ù€ (sein) Ø§Ø®ØªØ± Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„ØµØ­ÙŠØ­Ø©:`,
          choices: [
            "sein<b>e</b> Lampe (Nom, f)",
            "sein<b>en</b> Bruder (Akk, m)",
            "sein Buch (Akk, n)",
            "sein<b>em</b> Vater (Dat, m)",
            "sein<b>e</b> Kinder (Nom, Pl)",
          ],
          answers: [0, 1, 2, 3, 4],
          explain: "Ø§Ù„Ø­ÙŠØ§Ø¯ÙŠ Nom/Akk Ø¨Ù„Ø§ Ù†Ù‡Ø§ÙŠØ©: sein Buch.",
        },

        // GAP
        {
          type: "gap",
          cat: "Ù…Ù„ÙƒÙŠØ© â€” ÙØ±Ø§ØºØ§Øª",
          prompt: `Ø£ÙƒÙ…ÙÙ„ Ø§Ù„Ù†Ù‡Ø§ÙŠØ§Øª:`,
          segments: [
            '<span class="de">Ich kaufe ',
            " Mantel (mein, m, Akk).</span>",
          ],
          options: [["mein", "meinen", "meinem"]],
          answer: [1],
          explain: "Ù…Ø°ÙƒØ± ÙÙŠ AKK â†’ -en: meinen Mantel.",
        },

        {
          type: "gap",
          cat: "euer â€” ØªØ·Ø¨ÙŠÙ‚",
          prompt: `Ø§Ø®ØªØ± Ø§Ù„ØµØ­ÙŠØ­:`,
          segments: [
            '<span class="de">Wo ist ',
            " Tasche? (ihr, f, Nom)</span>",
          ],
          options: [["euer", "eure", "euren", "eurem"]],
          answer: [1],
          explain: "Ù…Ø¤Ù†Ø« ÙÙŠ NOM â†’ -e: eure Tasche.",
        },

        // TYPE
        {
          type: "type",
          cat: "Ù…Ù„ÙƒÙŠØ© â€” ÙƒØªØ§Ø¨Ø©",
          prompt: `Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ Ù…Ù„ÙƒÙŠØ© ØµØ­ÙŠØ­Ø©: <span class="de">Das ist (ich) <b>___</b> Buch.</span> (Nom, n)`,
          answersText: ["mein buch", "mein"],
          explain: "Ù†ÙŠÙˆØªØ± Nom â†’ Ø¨Ù„Ø§ Ù†Ù‡Ø§ÙŠØ©: mein Buch.",
        },
        {
          type: "type",
          cat: "Ù…Ù„ÙƒÙŠØ© â€” ÙƒØªØ§Ø¨Ø©",
          prompt: `Ø­ÙˆÙ‘Ù„: <span class="de">Ich sehe (wir) <b>___</b> Freunde.</span> (Akk, Pl)`,
          answersText: ["unsere freunde", "unsere"],
          explain: "Ø¬Ù…Ø¹ Akk â†’ -e: unsere Freunde.",
        },
        {
          type: "type",
          cat: "Ù…Ù„ÙƒÙŠØ© â€” ÙƒØªØ§Ø¨Ø©",
          prompt: `Ø­ÙˆÙ‘Ù„: <span class="de">Ich helfe (sie/Ù‡ÙŠ) <b>___</b> Mutter.</span> (Dat, f)`,
          answersText: ["ihrer mutter", "ihrer"],
          explain: "Ù…Ø¤Ù†Ø« Dat â†’ -er: ihrer Mutter.",
        },

        // ØªØ­ÙˆÙŠÙ„/ØªØ±ÙƒÙŠØ¨ Ø¬Ù…Ù„
        {
          type: "type",
          cat: "ØµÙŠØ§ØºØ© Ø¶Ù…ÙŠØ± Ù…Ù„ÙƒÙŠØ©",
          prompt: `ØªØ±Ø¬Ù…: <b>Ù‡Ø°Ù‡ Ø³ÙŠØ§Ø±ØªÙÙ‡</b> (Ù‡Ùˆ).`,
          answersText: ["das ist sein auto", "das ist sein auto."],
          explain: "sein + (n, Nom): sein Auto.",
        },
        {
          type: "type",
          cat: "ØµÙŠØ§ØºØ© Ø¶Ù…ÙŠØ± Ù…Ù„ÙƒÙŠØ©",
          prompt: `ØªØ±Ø¬Ù…: <b>Ø£Ù†Ø§ Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ø·ÙÙÙƒÙ…</b> (ihr, m, Akk).`,
          answersText: ["ich suche euren mantel", "ich suche den euren mantel"],
          explain: "Ù…Ø°ÙƒØ± Akk Ù…Ø¹ euer â†’ euren Mantel.",
        },
      ];

      /* ==== ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ==== */
      const SECTION_ORDER = [
        { key: "mc", title: "â‘  Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø­Ø¯ â€” Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± & Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³ & Ø§Ù„Ù…Ù„ÙƒÙŠØ©" },
        { key: "multi", title: "â‘¡ Ù…ØªØ¹Ø¯Ù‘Ø¯ â€” ØªØµÙ†ÙŠÙ ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø©" },
        { key: "gap", title: "â‘¢ ÙØ±Ø§ØºØ§Øª â€” Ù†Ù‡Ø§ÙŠØ§Øª & Ø£Ø¯ÙˆØ§Øª" },
        { key: "type", title: "â‘£ ÙƒØªØ§Ø¨Ø© â€” Ø¶Ù…Ø§Ø¦Ø± & ØªØ­ÙˆÙŠÙ„ Ù…Ù„ÙƒÙŠØ©" },
      ];

      function buildSections() {
        return SECTION_ORDER.map((sec) => {
          const all = QUESTIONS.filter((q) => q.type === sec.key);
          return { title: sec.title, key: sec.key, questions: all };
        }).filter((s) => s.questions.length > 0);
      }
      const SECTIONS = buildSections();

      /* ==== Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø© ==== */
      let globalAnswered = 0,
        globalCorrect = 0;
      let activeSectionIndex = -1;
      let i = 0,
        sectionScore = 0;

      const secList = document.getElementById("secList");
      const sectionsCard = document.getElementById("sectionsCard");
      const quizCard = document.getElementById("quizCard");
      const globalScoreEl = document.getElementById("globalScore");

      const bar = document.getElementById("bar");
      const qIndex = document.getElementById("qIndex");
      const qType = document.getElementById("qType");
      const promptEl = document.getElementById("prompt");
      const content = document.getElementById("content");
      const feedback = document.getElementById("feedback");
      const checkBtn = document.getElementById("checkBtn");
      const nextBtn = document.getElementById("nextBtn");
      const exitBtn = document.getElementById("exitBtn");
      const catPill = document.getElementById("catPill");

      function updateGlobal() {
        globalScoreEl.textContent = `Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${globalCorrect} / ${globalAnswered}`;
      }

      function renderSectionsList() {
        secList.innerHTML = "";
        SECTIONS.forEach((sec, idx) => {
          const total = sec.questions.length;
          const card = document.createElement("div");
          card.className = "sec-card";

          const left = document.createElement("div");
          left.className = "sec-left";
          const title = document.createElement("div");
          title.className = "sec-title";
          title.textContent = sec.title;
          const meta = document.createElement("div");
          meta.className = "sec-meta";
          meta.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${total}`;
          left.appendChild(title);
          left.appendChild(meta);

          const start = document.createElement("button");
          start.className = "start-btn";
          start.textContent = "Ø§Ø¨Ø¯Ø£ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…";
          start.onclick = () => startSection(idx);

          card.appendChild(left);
          card.appendChild(start);
          secList.appendChild(card);
        });
      }

      function startSection(secIdx) {
        activeSectionIndex = secIdx;
        i = 0;
        sectionScore = 0;
        sectionsCard.style.display = "none";
        quizCard.style.display = "block";
        renderQuestion();
      }

      function exitSection() {
        activeSectionIndex = -1;
        quizCard.style.display = "none";
        sectionsCard.style.display = "block";
        renderSectionsList();
      }

      function renderQuestion() {
        const sec = SECTIONS[activeSectionIndex];
        const q = sec.questions[i];

        feedback.innerHTML = "";
        nextBtn.disabled = true;
        checkBtn.disabled = false;

        qIndex.textContent = `Ø³Ø¤Ø§Ù„ ${i + 1} / ${sec.questions.length}`;
        qType.textContent =
          q.type === "mc"
            ? "Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯"
            : q.type === "multi"
            ? "Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ¹Ø¯Ø¯Ø©"
            : q.type === "gap"
            ? "Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ÙØ±Ø§ØºØ§Øª"
            : "Ø§ÙƒØªØ¨ Ø§Ù„Ø¬ÙˆØ§Ø¨";

        catPill.textContent = q.cat || "â€”";
        promptEl.innerHTML = q.prompt;
        content.innerHTML = "";
        bar.style.width = `${(i / sec.questions.length) * 100}%`;

        if (q.type === "mc") {
          const wrap = document.createElement("div");
          wrap.className = "choices";
          q.choices.forEach((c, ix) => {
            const b = document.createElement("button");
            b.className = "choice";
            b.innerHTML = c;
            b.onclick = () => {
              [...wrap.children].forEach((x) => x.classList.remove("selected"));
              b.classList.add("selected");
            };
            wrap.appendChild(b);
          });
          content.appendChild(wrap);
        }

        if (q.type === "multi") {
          const wrap = document.createElement("div");
          wrap.className = "choices";
          q.choices.forEach((c, ix) => {
            const b = document.createElement("button");
            b.className = "choice";
            b.innerHTML = c;
            b.onclick = () => b.classList.toggle("selected");
            wrap.appendChild(b);
          });
          content.appendChild(wrap);
        }

        if (q.type === "gap") {
          const gl = document.createElement("div");
          gl.className = "gap-line";
          q.segments.forEach((seg, ix) => {
            gl.insertAdjacentHTML("beforeend", seg);
            if (ix < (q.options?.length || 0)) {
              const s = document.createElement("select");
              s.className = "gap";
              q.options[ix].forEach((opt) => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt;
                s.appendChild(o);
              });
              gl.appendChild(s);
            }
          });
          content.appendChild(gl);
        }

        if (q.type === "type") {
          const box = document.createElement("div");
          box.className = "type-wrap";
          const inp = document.createElement("input");
          inp.type = "text";
          inp.className = "type-input";
          inp.placeholder = q.placeholder || "Ø§ÙƒØªØ¨ Ø§Ù„Ø¬ÙˆØ§Ø¨ Ù‡Ù†Ø§...";
          inp.autocomplete = "off";
          inp.spellcheck = false;
          box.appendChild(inp);
          content.appendChild(box);
          if (q.note) {
            const note = document.createElement("div");
            note.className = "hint";
            note.innerHTML = q.note;
            content.appendChild(note);
          }
        }
      }

      function getUserAnswer(q) {
        if (q.type === "mc") {
          const sel = content.querySelector(".choice.selected");
          return sel
            ? [...content.querySelectorAll(".choice")].indexOf(sel)
            : null;
        }
        if (q.type === "multi") {
          return [...content.querySelectorAll(".choice.selected")]
            .map((btn) => [...content.querySelectorAll(".choice")].indexOf(btn))
            .sort((a, b) => a - b);
        }
        if (q.type === "gap") {
          return [...content.querySelectorAll("select.gap")].map(
            (s) => s.value
          );
        }
        if (q.type === "type") {
          const input = content.querySelector(".type-input");
          return input ? input.value : "";
        }
      }

      document.getElementById("checkBtn").onclick = () => {
        if (activeSectionIndex < 0) return;
        const sec = SECTIONS[activeSectionIndex];
        const q = sec.questions[i];
        const ua = getUserAnswer(q);

        if (
          ua === null ||
          (Array.isArray(ua) && ua.length === 0) ||
          (q.type === "type" && String(ua).trim() === "")
        ) {
          feedback.innerHTML =
            '<div class="feedback tip">Ø§Ø®ØªØ±/Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨Ø© Ø£ÙˆÙ„Ù‹Ø§.</div>';
          return;
        }

        let correct = false;
        if (q.type === "mc") correct = ua === q.answer;
        if (q.type === "multi") correct = arraysEqual(ua, q.answers);
        if (q.type === "gap")
          correct = arraysEqual(
            ua,
            q.answer.map((ii, ix) => q.options[ix][ii])
          );
        if (q.type === "type") {
          const accepted = (q.answersText || []).map(normalizeText);
          const normalized = normalizeText(ua);
          correct = accepted.includes(normalized);
        }

        // ÙˆØ³ÙˆÙ… Ù…Ø±Ø¦ÙŠØ©
        if (q.type === "mc" || q.type === "multi") {
          const btns = [...content.querySelectorAll(".choice")];
          if (q.type === "mc") {
            btns.forEach((b, ix) => {
              if (ix === q.answer) b.classList.add("correct");
              if (ix !== q.answer && b.classList.contains("selected"))
                b.classList.add("wrong");
            });
          } else {
            btns.forEach((b, ix) => {
              if ((q.answers || []).includes(ix)) b.classList.add("correct");
              if (
                !(q.answers || []).includes(ix) &&
                b.classList.contains("selected")
              )
                b.classList.add("wrong");
            });
          }
        }
        if (q.type === "gap") {
          const sels = [...content.querySelectorAll("select.gap")];
          sels.forEach((s, ix) => {
            const right = q.options[ix][q.answer[ix]];
            s.style.borderColor =
              s.value === right ? "var(--success)" : "var(--danger)";
          });
        }
        if (q.type === "type") {
          const input = content.querySelector(".type-input");
          if (input) {
            input.classList.toggle("ok", correct);
            input.classList.toggle("bad", !correct);
          }
        }

        feedback.innerHTML = `<div class="feedback ${correct ? "ok" : "bad"}">${
          correct ? "ØµØ­ÙŠØ­ âœ…" : "ØºÙŠØ± ØµØ­ÙŠØ­ âŒ"
        } ${q.explain || ""}</div>`;
        globalAnswered++;
        if (correct) {
          globalCorrect++;
          sectionScore++;
        }
        updateGlobal();

        nextBtn.disabled = false;
        checkBtn.disabled = true;

        const last = i === sec.questions.length - 1;
        nextBtn.textContent = last ? "Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù‚Ø³Ù…" : "Ø§Ù„ØªØ§Ù„ÙŠ âŸµ";
      };

      document.getElementById("nextBtn").onclick = () => {
        const sec = SECTIONS[activeSectionIndex];
        if (i < sec.questions.length - 1) {
          i++;
          renderQuestion();
          nextBtn.disabled = true;
          bar.style.width = `${(i / sec.questions.length) * 100}%`;
        } else {
          const percent = Math.round(
            (sectionScore / sec.questions.length) * 100
          );
          quizCard.innerHTML = `
            <div class="prompt" style="text-align:center;font-size:26px;margin-bottom:8px">${
              sec.title
            }</div>
            <div class="feedback ${
              percent >= 80 ? "ok" : percent >= 60 ? "tip" : "bad"
            }" style="font-size:18px;text-align:center">
              Ù†ØªÙŠØ¬ØªÙƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…: <b>${sectionScore}</b> Ù…Ù† <b>${
            sec.questions.length
          }</b> â€” (${percent}%)
            </div>
            <div class="actions" style="justify-content:center;margin-top:16px">
              <button class="primary" onclick="(${exitSection.toString()})();">Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
            </div>
          `;
        }
      };

      document.getElementById("exitBtn").onclick = () => exitSection();

      // Init
      function init() {
        applySidebarMode();
        renderSectionsList();
        updateGlobal();
      }
      init();
    </script>
  </body>
</html>
