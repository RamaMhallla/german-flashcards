<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>اختبار Dativ — أقسام حسب نوع السؤال</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #06b6d4;
        --primary-light: #22d3ee;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --light-bg: #f9fafb;
        --card-bg: #fff;
        --text: #1f2937;
        --text-light: #6b7280;
        --border: #e5e7eb;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --sidebar-w: 280px;
        --sidebar-bg: #fff;
        --sidebar-border: #e5e7eb;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Tajawal", sans-serif;
        min-height: 100vh;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      }

      .topbar {
        display: none;
        position: sticky;
        top: 0;
        z-index: 20;
        background: #fff;
        border-bottom: 1px solid var(--border);
        padding: 10px 14px;
      }
      .hamburger {
        all: unset;
        cursor: pointer;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
      }

      .layout {
        display: grid;
        grid-template-columns: var(--sidebar-w) 1fr;
        min-height: 100vh;
      }
      aside.sidebar {
        background: var(--sidebar-bg);
        border-inline-end: 1px solid var(--sidebar-border);
        padding: 18px;
        position: sticky;
        top: 0;
        height: 100vh;
        overflow: auto;
        box-shadow: var(--shadow);
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
      }
      .logo {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        background: linear-gradient(
          135deg,
          var(--primary-light),
          var(--primary)
        );
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 700;
        box-shadow: 0 6px 14px rgba(6, 182, 212, 0.25);
      }
      .brand h1 {
        font-size: 18px;
        margin: 0;
      }
      .muted {
        color: var(--text-light);
        font-size: 13px;
      }
      nav.nav {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .section {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: #fff;
      }
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        cursor: pointer;
      }
      .section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        color: var(--primary);
      }
      .chev {
        transition: transform 0.2s ease;
      }
      .section[aria-expanded="true"] .chev {
        transform: rotate(180deg);
      }
      .section-body {
        display: none;
        border-top: 1px solid var(--border);
      }
      .section[aria-expanded="true"] .section-body {
        display: block;
      }
      .submenu {
        padding: 10px;
      }
      .slink {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-radius: 10px;
        text-decoration: none;
        color: var(--text);
        transition: 0.15s;
        border: 1px solid transparent;
      }
      .slink:hover {
        background: #f8fafc;
        border-color: var(--border);
      }
      .chip {
        font-size: 12px;
        background: #cffafe;
        color: #0e7490;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid #a5f3fc;
      }
      .active {
        background: #ecfeff;
        border-color: #a5f3fc;
      }

      main.content {
        padding: 24px;
      }
      .app {
        width: min(980px, 100%);
        margin: auto;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }
      h1 {
        font-size: clamp(24px, 3.4vw, 36px);
        margin: 0;
        line-height: 1.3;
        color: var(--primary);
        font-weight: 700;
      }
      .subtitle {
        color: var(--text-light);
        font-size: clamp(14px, 1.6vw, 17px);
        margin-top: 8px;
        max-width: 650px;
      }
      .pill {
        background: #f1f5f9;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 13px;
        color: var(--primary);
        font-weight: 600;
      }

      .card {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: var(--shadow);
        padding: 24px;
        border: 1px solid var(--border);
      }
      .progress {
        height: 12px;
        background: #f3f4f6;
        border-radius: 999px;
        overflow: hidden;
        margin: 14px 0 18px;
      }
      .progress > span {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(
          90deg,
          var(--primary-light),
          var(--primary)
        );
        transition: width 0.4s ease;
      }
      .q-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        color: var(--text-light);
        margin-bottom: 14px;
      }
      .q-index {
        padding: 6px 14px;
        border-radius: 999px;
        background: #f1f5f9;
        color: var(--primary);
        font-weight: 700;
        font-size: 14px;
      }
      .q-type {
        font-size: 14px;
        color: var(--primary);
        background: #ecfeff;
        padding: 4px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
      }
      .prompt {
        font-size: clamp(18px, 2.7vw, 24px);
        line-height: 1.6;
        margin: 10px 0 18px;
        color: var(--text);
      }
      .de {
        direction: ltr;
        unicode-bidi: plaintext;
        background: #f8fafc;
        padding: 4px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        display: inline-block;
        font-family: monospace;
        font-size: 0.95em;
      }

      .choices {
        display: grid;
        gap: 12px;
      }
      .choice {
        padding: 16px 18px;
        border-radius: 14px;
        background: #f8fafc;
        border: 2px solid var(--border);
        cursor: pointer;
        transition: 0.2s;
        font-weight: 500;
        text-align: right;
      }
      .choice:hover {
        border-color: var(--primary-light);
        background: #ecfeff;
      }
      .choice.selected {
        border-color: var(--primary);
        background: #cffafe;
      }
      .choice.correct {
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.1);
      }
      .choice.wrong {
        border-color: var(--danger);
        background: rgba(239, 68, 68, 0.1);
      }

      .gap-line {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin: 10px 0;
      }
      select.gap {
        padding: 10px 14px;
        border-radius: 10px;
        background: #f8fafc;
        color: var(--text);
        border: 2px solid var(--border);
        min-width: 110px;
      }
      .mini-note {
        color: var(--text-light);
        font-size: 14px;
        margin-top: 6px;
      }

      .actions {
        display: flex;
        gap: 12px;
        margin-top: 18px;
        flex-wrap: wrap;
      }
      button {
        all: unset;
        padding: 12px 18px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .primary {
        background: linear-gradient(
          90deg,
          var(--primary),
          var(--primary-light)
        );
        color: #fff;
      }
      .ghost {
        border: 2px solid var(--border);
        background: #fff;
        color: var(--text);
      }
      .feedback {
        margin-top: 16px;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid;
      }
      .ok {
        background: rgba(16, 185, 129, 0.1);
        border-color: var(--success);
        color: #065f46;
      }
      .bad {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--danger);
        color: #991b1b;
      }
      .tip {
        background: rgba(245, 158, 11, 0.1);
        border-color: var(--warning);
        color: #92400e;
      }

      .section-list {
        display: grid;
        gap: 14px;
        margin-bottom: 18px;
      }
      .sec-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border: 1px solid var(--border);
        border-radius: 14px;
        background: #fff;
      }
      .sec-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .sec-title {
        font-weight: 800;
        color: var(--primary);
      }
      .sec-meta {
        font-size: 13px;
        color: var(--text-light);
      }
      .start-btn {
        all: unset;
        background: linear-gradient(
          90deg,
          var(--primary),
          var(--primary-light)
        );
        color: #fff;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
      }

      .type-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: center;
      }
      .type-input {
        padding: 12px 14px;
        border: 2px solid var(--border);
        border-radius: 12px;
        min-width: 280px;
        font-family: inherit;
        font-size: 16px;
        background: #fff;
        direction: ltr;
      }
      .type-input:focus {
        outline: none;
        border-color: var(--primary);
      }
      .type-input.ok {
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.08);
      }
      .type-input.bad {
        border-color: var(--danger);
        background: rgba(239, 68, 68, 0.08);
      }
      .hint {
        color: var(--text-light);
        font-size: 13px;
        margin-top: 6px;
        text-align: center;
      }

      @media (max-width: 900px) {
        .topbar {
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .layout {
          grid-template-columns: 1fr;
        }
        aside.sidebar {
          position: fixed;
          inset-inline-start: 0;
          top: 52px;
          bottom: 0;
          width: 80vw;
          max-width: 320px;
          transform: translateX(100%);
          transition: 0.2s;
        }
        aside.sidebar.open {
          transform: translateX(0);
        }
        main.content {
          padding: 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <button class="hamburger" id="menuBtn">☰</button>
      <strong>Dativ Quiz</strong>
    </div>

    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="brand">
          <div class="logo">DE</div>
          <div>
            <h1>اختبارات الألمانية</h1>
            <div class="muted">Nominativ · Akkusativ · Dativ</div>
          </div>
        </div>
        <nav class="nav">
          <div class="section" aria-expanded="true">
            <div class="section-header">
              <div class="section-title">📘 الحالات الإعرابية</div>
              <div class="chev">⌄</div>
            </div>
            <div class="section-body">
              <div class="submenu">
                <a class="slink" href="nominativ.html"
                  ><span>① Nominativ</span><span class="chip">اختبار</span></a
                >
                <a class="slink" href="Akkusativ.html"
                  ><span>② Akkusativ</span><span class="chip">أقسام</span></a
                >
                <a class="slink active" href="#"
                  ><span>③ Dativ</span><span class="chip">أقسام</span></a
                >
              </div>
            </div>
          </div>
        </nav>
      </aside>

      <!-- Main -->
      <main class="content">
        <div class="app">
          <div class="header">
            <div>
              <h1>
                اختبار تفاعلي:
                <span style="color: var(--primary-light)">Der Dativ</span>
              </h1>
              <div class="subtitle">
                شامل: <b>dem/der/dem/den</b> · <b>einem/einer/einem</b> · النفي
                <b>keinem/keiner/keinem/keinen</b> · الضمائر
                <b>mir/dir/ihm/ihr/ihm/uns/euch/ihnen/Ihnen</b> · أفعال Dativ:
                <span class="de"
                  >helfen, danken, glauben, antworten, folgen, begegnen,
                  schmecken, absagen</span
                >
                · أداة السؤال <b>Wem?</b>
              </div>
            </div>
            <div class="pill" id="globalScore">النتيجة الإجمالية: 0 / 0</div>
          </div>

          <!-- Sections List -->
          <div class="card" id="sectionsCard">
            <div class="section-list" id="secList"></div>
          </div>

          <!-- Active Section Quiz -->
          <div class="card" id="quizCard" style="display: none">
            <div class="q-meta">
              <div class="q-index" id="qIndex">سؤال 1 / ?</div>
              <div class="q-type" id="qType"></div>
            </div>
            <div class="progress"><span id="bar"></span></div>
            <div class="prompt" id="prompt"></div>
            <div id="content"></div>
            <div class="actions">
              <button class="primary" id="checkBtn">تحقّق</button>
              <button class="ghost" id="nextBtn" disabled>التالي ⟵</button>
              <button class="ghost" id="exitBtn">إنهاء القسم</button>
            </div>
            <div id="feedback"></div>
            <div class="pill" id="catPill" style="margin-top: 10px">—</div>
          </div>

          <details class="card" style="margin-top: 18px">
            <summary
              style="cursor: pointer; color: var(--primary); font-weight: 700"
            >
              📒 أمثلة الدفتر المعتمدة هنا
            </summary>
            <div
              class="examples-wrap"
              style="
                margin-top: 10px;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 12px;
              "
            >
              <div class="ex"><div class="de">Ich helfe dem Mann</div></div>
              <div class="ex">
                <div class="de">Ich danke dir · Glaubst du ihm?</div>
              </div>
              <div class="ex">
                <div class="de">Sie antwortet ihrem Vater</div>
              </div>
              <div class="ex">
                <div class="de">Gestern bin ich deinem Vater begegnet</div>
              </div>
              <div class="ex"><div class="de">Folgen Sie mir!</div></div>
              <div class="ex">
                <div class="de">Das Essen hat mir nicht geschmeckt</div>
              </div>
              <div class="ex">
                <div class="de">Hat es Ihnen geschmeckt?</div>
              </div>
              <div class="ex">
                <div class="de">Wem helfe ich? — Ich helfe dem Mann</div>
              </div>
            </div>
          </details>
        </div>
      </main>
    </div>

    <script>
      /* ===== Sidebar ===== */
      document.querySelectorAll(".section-header").forEach((h) => {
        h.addEventListener("click", () =>
          h.parentElement.toggleAttribute("aria-expanded")
        );
      });
      const sidebar = document.getElementById("sidebar");
      const menuBtn = document.getElementById("menuBtn");
      if (menuBtn) menuBtn.onclick = () => sidebar.classList.toggle("open");

      /* ===== Utils ===== */
      function arraysEqual(a, b) {
        return (
          Array.isArray(a) &&
          Array.isArray(b) &&
          a.length === b.length &&
          a.every((v, i) => v === b[i])
        );
      }
      function normalizeText(s) {
        return String(s || "")
          .toLowerCase()
          .replace(/[؟?!.]+$/, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      /* ===== Question Bank (Dativ) ===== */
      const QUESTIONS = [
        /* MC - أدوات تعريف/نكرة/نفي */
        {
          type: "mc",
          cat: "der → dem",
          prompt: `أكمل: <span class="de">Ich helfe ___ Mann.</span>`,
          choices: ["der", "dem", "den"],
          answer: 1,
          explain: 'مع Dativ المذكر → <span class="de">dem</span>.',
        },
        {
          type: "mc",
          cat: "die → der",
          prompt: `أكمل: <span class="de">Ich danke ___ Frau.</span>`,
          choices: ["der", "die", "dem"],
          answer: 0,
          explain: 'المؤنث في Dativ → <span class="de">der</span>.',
        },
        {
          type: "mc",
          cat: "das → dem",
          prompt: `أكمل: <span class="de">Ich antworte ___ Kind.</span>`,
          choices: ["dem", "den", "der"],
          answer: 0,
          explain: 'الحيادي في Dativ → <span class="de">dem</span>.',
        },
        {
          type: "mc",
          cat: "Plural → den + -n",
          prompt: `أكمل: <span class="de">Ich helfe ___ Kindern.</span>`,
          choices: ["den", "die", "dem"],
          answer: 0,
          explain:
            'الجمع في Dativ: <span class="de">den Kindern</span> (وغالبًا نضيف -n).',
        },
        {
          type: "mc",
          cat: "ein → einem",
          prompt: `أكمل: <span class="de">Sie hilft ___ Mann.</span>`,
          choices: ["ein", "einem", "einen"],
          answer: 1,
          explain: 'المذكر النكرة في Dativ → <span class="de">einem</span>.',
        },
        {
          type: "mc",
          cat: "eine → einer",
          prompt: `أكمل: <span class="de">Er gratuliert ___ Frau.</span>`,
          choices: ["eine", "einer", "einem"],
          answer: 1,
          explain: 'المؤنث النكرة → <span class="de">einer</span>.',
        },
        {
          type: "mc",
          cat: "kein → keinem",
          prompt: `أكمل: <span class="de">Ich glaube ___ Mann.</span> <span class="mini-note">(نفي)</span>`,
          choices: ["kein", "keinem", "keinen"],
          answer: 1,
          explain: 'نفي المذكر Dativ → <span class="de">keinem</span>.',
        },
        {
          type: "mc",
          cat: "Plural منفي",
          prompt: `أكمل: <span class="de">Er hilft ___ Kindern.</span> <span class="mini-note">(نفي)</span>`,
          choices: ["keinen", "keinem", "keine"],
          answer: 0,
          explain: 'نفي الجمع Dativ → <span class="de">keinen Kindern</span>.',
        },

        /* MULTI - أفعال Dativ وضمائر */
        {
          type: "multi",
          cat: "Verben mit Dativ",
          prompt: `اختر الأفعال التي تأخذ Dativ غالبًا`,
          choices: [
            "helfen",
            "danken",
            "sehen",
            "glauben",
            "antworten",
            "kaufen",
            "folgen",
            "begegnen",
            "schmecken",
            "absagen",
          ],
          answers: [0, 1, 3, 4, 6, 7, 8, 9],
          explain:
            "Dativ: helfen, danken, glauben, antworten, folgen, begegnen, schmecken, absagen. (sehen/kaufen ليست Dativ).",
        },
        {
          type: "multi",
          cat: "ضمائر Dativ",
          prompt: `اختر ضمائر Dativ الصحيحة`,
          choices: [
            "mir",
            "dich",
            "ihm",
            "ihr",
            "uns",
            "euch",
            "ihnen",
            "Sie",
            "Ihnen",
          ],
          answers: [0, 2, 3, 4, 5, 6, 8],
          explain: "Dativ: mir, dir, ihm, ihr, ihm, uns, euch, ihnen/Ihnen.",
        },

        /* GAP - Wem؟ وغيره */
        {
          type: "gap",
          cat: "Wem?",
          prompt: `اختر أداة السؤال المناسبة:`,
          segments: ['<span class="de">___ hilfst du?</span>'],
          options: [["Wer", "Wem", "Was"]],
          answer: [1],
          explain: "نسأل عن المفعول غير المباشر بـ <b>Wem?</b>.",
        },
        {
          type: "gap",
          cat: "تحويلات شائعة",
          prompt: `حوّل للأداة الصحيحة (Dativ):`,
          segments: ['<span class="de">Ich spreche mit ', " Mann.</span>"],
          options: [["der", "dem", "den", "einem", "einen", "keinem"]],
          answer: [1],
          explain:
            'مع <span class="de">mit</span> دائمًا Dativ: <span class="de">dem Mann</span>.',
        },
        {
          type: "gap",
          cat: "ملك + Dativ",
          prompt: `أكمل:`,
          segments: ['<span class="de">Sie schreibt ', " Vater.</span>"],
          options: [["ihr", "ihrem", "ihren", "ihren (Plural)"]],
          answer: [1],
          explain: 'مع Dativ: <span class="de">ihrem Vater</span>.',
        },
        {
          type: "gap",
          cat: "سؤال/جواب",
          prompt: `أكمل:`,
          segments: [
            '<span class="de">Wem antwortest du?</span> — <span class="de">Ich antworte ',
            " Lehrer.</span>",
          ],
          options: [["dem", "den", "der", "einem"]],
          answer: [0],
          explain: '<span class="de">dem Lehrer</span>.',
        },

        /* TYPE - كتابة حرّة تدريب قواعد */
        {
          type: "type",
          cat: "اكتب الشكل الصحيح",
          prompt: `حوّل إلى Dativ: <span class="de">Ich helfe <b>der Mann</b>.</span>`,
          placeholder: "dem Mann",
          answersText: ["dem mann"],
          explain: '<span class="de">dem Mann</span>.',
        },
        {
          type: "type",
          cat: "ضمائر Dativ",
          prompt: `بدّل الاسم بضمير (Dativ): <span class="de">Ich danke <b>meiner Mutter</b>.</span>`,
          placeholder: "ihr",
          answersText: ["ihr"],
          explain: '<span class="de">ihr</span>.',
        },
        {
          type: "type",
          cat: "أداة مع حرف جر",
          prompt: `اكتب الكامل: <span class="de">Er spricht <b>mit</b> ___ Lehrer.</span>`,
          placeholder: "mit dem Lehrer",
          answersText: ["mit dem lehrer"],
          explain: 'مع <span class="de">mit</span> → Dativ.',
        },
        {
          type: "type",
          cat: "نفي Dativ",
          prompt: `حوّل للنفي: <span class="de">Ich glaube <b>einem Mann</b> (لا).</span>`,
          placeholder: "keinem Mann",
          answersText: ["keinem mann"],
          explain: '<span class="de">keinem Mann</span>.',
        },

        /* TYPE - ترجمة عربي → ألماني */
        {
          type: "type",
          cat: "ترجمة (Dativ)",
          prompt: `ترجم: <b>أنا أساعد الرجل.</b>`,
          placeholder: "Ich helfe dem Mann",
          answersText: ["ich helfe dem mann"],
          explain: '<span class="de">Ich helfe dem Mann.</span>',
        },
        {
          type: "type",
          cat: "ترجمة (Dativ)",
          prompt: `ترجم: <b>هل تشكرني؟</b>`,
          placeholder: "Dankst du mir?",
          answersText: ["dankst du mir"],
          explain: '<span class="de">Dankst du mir?</span>',
        },
        {
          type: "type",
          cat: "ترجمة (Dativ)",
          prompt: `ترجم: <b>الطعام لم يعجبني.</b>`,
          placeholder: "Das Essen hat mir nicht geschmeckt",
          answersText: ["das essen hat mir nicht geschmeckt"],
          explain: "جملة من الدفتر.",
        },

        /* TYPE - صياغة السؤال (Wem?) */
        {
          type: "type",
          cat: "اصنع سؤال (Wem?)",
          prompt: `اكتب السؤال عن المفعول:<br><span class="de">Ich helfe <b>dem Mann</b>.</span>`,
          placeholder: "Wem hilfst du?",
          answersText: ["wem hilfst du"],
          explain: '<span class="de">Wem hilfst du?</span>',
        },
        {
          type: "type",
          cat: "اصنع سؤال (Wem?)",
          prompt: `اكتب السؤال:<br><span class="de">Sie antwortet <b>ihrem Vater</b>.</span>`,
          placeholder: "Wem antwortet sie?",
          answersText: ["wem antwortet sie"],
          explain: '<span class="de">Wem antwortet sie?</span>',
        },
      ];

      /* ===== تقسيم الأقسام حسب النوع ===== */
      const SECTION_ORDER = [
        { key: "mc", title: "① اختيار واحد (MC)" },
        { key: "multi", title: "② متعدّد (Multi)" },
        { key: "gap", title: "③ فراغات منسدلة (Gap)" },
        { key: "type", title: "④ كتابة حرّة (Type)" },
        {
          key: "type",
          title: "⑤ ترجمة عربي → ألماني",
          filterCatPrefix: "ترجمة",
        },
        {
          key: "type",
          title: "⑥ صياغة السؤال (Wem?)",
          filterCatPrefix: "اصنع سؤال",
        },
      ];

      function buildSections() {
        return SECTION_ORDER.map((sec) => {
          const all = QUESTIONS.filter((q) => q.type === sec.key);
          const filtered = sec.filterCatPrefix
            ? all.filter((q) => (q.cat || "").startsWith(sec.filterCatPrefix))
            : all.filter(
                (q) =>
                  !(q.cat || "").startsWith("ترجمة") &&
                  !(q.cat || "").startsWith("اصنع سؤال")
              );
          return { title: sec.title, key: sec.key, questions: filtered };
        }).filter((s) => s.questions.length > 0);
      }

      const SECTIONS = buildSections();

      /* ===== حالة عامة ===== */
      let globalAnswered = 0,
        globalCorrect = 0;
      let activeSectionIndex = -1;
      let i = 0,
        sectionScore = 0;

      const secList = document.getElementById("secList");
      const sectionsCard = document.getElementById("sectionsCard");
      const quizCard = document.getElementById("quizCard");
      const globalScoreEl = document.getElementById("globalScore");

      const bar = document.getElementById("bar");
      const qIndex = document.getElementById("qIndex");
      const qType = document.getElementById("qType");
      const promptEl = document.getElementById("prompt");
      const content = document.getElementById("content");
      const feedback = document.getElementById("feedback");
      const checkBtn = document.getElementById("checkBtn");
      const nextBtn = document.getElementById("nextBtn");
      const exitBtn = document.getElementById("exitBtn");
      const catPill = document.getElementById("catPill");

      function updateGlobal() {
        globalScoreEl.textContent = `النتيجة الإجمالية: ${globalCorrect} / ${globalAnswered}`;
      }

      function renderSectionsList() {
        secList.innerHTML = "";
        SECTIONS.forEach((sec, idx) => {
          const total = sec.questions.length;
          const card = document.createElement("div");
          card.className = "sec-card";
          const left = document.createElement("div");
          left.className = "sec-left";
          const title = document.createElement("div");
          title.className = "sec-title";
          title.textContent = sec.title;
          const meta = document.createElement("div");
          meta.className = "sec-meta";
          meta.textContent = `عدد الأسئلة: ${total}`;
          left.appendChild(title);
          left.appendChild(meta);

          const start = document.createElement("button");
          start.className = "start-btn";
          start.textContent = "ابدأ هذا القسم";
          start.onclick = () => startSection(idx);

          card.appendChild(left);
          card.appendChild(start);
          secList.appendChild(card);
        });
      }

      function startSection(secIdx) {
        activeSectionIndex = secIdx;
        i = 0;
        sectionScore = 0;
        sectionsCard.style.display = "none";
        quizCard.style.display = "block";
        renderQuestion();
      }

      function exitSection() {
        activeSectionIndex = -1;
        quizCard.style.display = "none";
        sectionsCard.style.display = "block";
        renderSectionsList();
      }

      function renderQuestion() {
        const sec = SECTIONS[activeSectionIndex];
        const q = sec.questions[i];

        feedback.innerHTML = "";
        nextBtn.disabled = true;
        checkBtn.disabled = false;

        qIndex.textContent = `سؤال ${i + 1} / ${sec.questions.length}`;
        qType.textContent =
          q.type === "mc"
            ? "اختيار من متعدد"
            : q.type === "multi"
            ? "أسئلة متعددة"
            : q.type === "gap"
            ? "إكمال الفراغات"
            : q.cat && q.cat.startsWith("ترجمة")
            ? "ترجمة كتابة"
            : q.cat && q.cat.startsWith("اصنع سؤال")
            ? "صياغة سؤال"
            : "اكتب الجواب";
        catPill.textContent = q.cat || "—";
        promptEl.innerHTML = q.prompt;
        content.innerHTML = "";

        bar.style.width = `${(i / sec.questions.length) * 100}%`;

        if (q.type === "mc") {
          const wrap = document.createElement("div");
          wrap.className = "choices";
          q.choices.forEach((c, ix) => {
            const b = document.createElement("button");
            b.className = "choice";
            b.innerHTML = c;
            b.onclick = () => {
              [...wrap.children].forEach((x) => x.classList.remove("selected"));
              b.classList.add("selected");
            };
            wrap.appendChild(b);
          });
          content.appendChild(wrap);
        }

        if (q.type === "multi") {
          const wrap = document.createElement("div");
          wrap.className = "choices";
          q.choices.forEach((c, ix) => {
            const b = document.createElement("button");
            b.className = "choice";
            b.innerHTML = c;
            b.onclick = () => b.classList.toggle("selected");
            wrap.appendChild(b);
          });
          content.appendChild(wrap);
        }

        if (q.type === "gap") {
          const gl = document.createElement("div");
          gl.className = "gap-line";
          q.segments.forEach((seg, ix) => {
            gl.insertAdjacentHTML("beforeend", seg);
            if (ix < q.options.length) {
              const s = document.createElement("select");
              s.className = "gap";
              q.options[ix].forEach((opt) => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt;
                s.appendChild(o);
              });
              gl.appendChild(s);
            }
          });
          content.appendChild(gl);
        }

        if (q.type === "type") {
          const box = document.createElement("div");
          box.className = "type-wrap";
          const inp = document.createElement("input");
          inp.type = "text";
          inp.className = "type-input";
          inp.placeholder = q.placeholder || "اكتب الجواب هنا...";
          inp.autocomplete = "off";
          inp.spellcheck = false;
          box.appendChild(inp);
          content.appendChild(box);
          if (q.note) {
            const note = document.createElement("div");
            note.className = "hint";
            note.innerHTML = q.note;
            content.appendChild(note);
          }
        }
      }

      function getUserAnswer(q) {
        if (q.type === "mc") {
          const sel = content.querySelector(".choice.selected");
          return sel
            ? [...content.querySelectorAll(".choice")].indexOf(sel)
            : null;
        }
        if (q.type === "multi") {
          return [...content.querySelectorAll(".choice.selected")]
            .map((btn) => [...content.querySelectorAll(".choice")].indexOf(btn))
            .sort((a, b) => a - b);
        }
        if (q.type === "gap") {
          return [...content.querySelectorAll("select.gap")].map(
            (s) => s.value
          );
        }
        if (q.type === "type") {
          const input = content.querySelector(".type-input");
          return input ? input.value : "";
        }
      }

      checkBtn.onclick = () => {
        if (activeSectionIndex < 0) return;
        const sec = SECTIONS[activeSectionIndex];
        const q = sec.questions[i];
        const ua = getUserAnswer(q);

        if (
          ua === null ||
          (Array.isArray(ua) && ua.length === 0) ||
          (q.type === "type" && String(ua).trim() === "")
        ) {
          feedback.innerHTML =
            '<div class="feedback tip">اختر/اكتب إجابة أولاً.</div>';
          return;
        }

        let correct = false;
        if (q.type === "mc") correct = ua === q.answer;
        if (q.type === "multi") correct = arraysEqual(ua, q.answers);
        if (q.type === "gap")
          correct = arraysEqual(
            ua,
            q.answer.map((ii, ix) => q.options[ix][ii])
          );
        if (q.type === "type") {
          const accepted = (q.answersText || []).map(normalizeText);
          const normalized = normalizeText(ua);
          correct = accepted.includes(normalized);
        }

        if (q.type === "mc" || q.type === "multi") {
          const btns = [...content.querySelectorAll(".choice")];
          if (q.type === "mc") {
            btns.forEach((b, ix) => {
              if (ix === q.answer) b.classList.add("correct");
              if (ix !== q.answer && b.classList.contains("selected"))
                b.classList.add("wrong");
            });
          } else {
            btns.forEach((b, ix) => {
              if ((q.answers || []).includes(ix)) b.classList.add("correct");
              if (
                !(q.answers || []).includes(ix) &&
                b.classList.contains("selected")
              )
                b.classList.add("wrong");
            });
          }
        }
        if (q.type === "gap") {
          const sels = [...content.querySelectorAll("select.gap")];
          sels.forEach((s, ix) => {
            const right = q.options[ix][q.answer[ix]];
            s.style.borderColor =
              s.value === right ? "var(--success)" : "var(--danger)";
          });
        }
        if (q.type === "type") {
          const input = content.querySelector(".type-input");
          if (input) {
            input.classList.toggle("ok", correct);
            input.classList.toggle("bad", !correct);
          }
        }

        feedback.innerHTML = `<div class="feedback ${correct ? "ok" : "bad"}">${
          correct ? "صحيح ✅" : "غير صحيح ❌"
        } ${q.explain || ""}</div>`;
        globalAnswered++;
        if (correct) {
          globalCorrect++;
          sectionScore++;
        }
        updateGlobal();

        nextBtn.disabled = false;
        checkBtn.disabled = true;

        if (i === sec.questions.length - 1) {
          nextBtn.textContent = "إنهاء وعرض نتيجة القسم";
        } else {
          nextBtn.textContent = "التالي ⟵";
        }
      };

      nextBtn.onclick = () => {
        const sec = SECTIONS[activeSectionIndex];
        if (i < sec.questions.length - 1) {
          i++;
          renderQuestion();
          nextBtn.disabled = true;
          document.getElementById("bar").style.width = `${
            (i / sec.questions.length) * 100
          }%`;
        } else {
          const percent = Math.round(
            (sectionScore / sec.questions.length) * 100
          );
          quizCard.innerHTML = `
        <div class="prompt" style="text-align:center;font-size:26px;margin-bottom:8px">${
          sec.title
        }</div>
        <div class="feedback ${
          percent >= 80 ? "ok" : percent >= 60 ? "tip" : "bad"
        }" style="font-size:18px;text-align:center">
          نتيجتك في هذا القسم: <b>${sectionScore}</b> من <b>${
            sec.questions.length
          }</b> — (${percent}%)
        </div>
        <div class="actions" style="justify-content:center;margin-top:16px">
          <button class="primary" onclick="exitSection()">رجوع إلى الأقسام</button>
        </div>
      `;
        }
      };

      exitBtn.onclick = () => exitSection();

      function renderSectionsList() {
        const secList = document.getElementById("secList");
        secList.innerHTML = "";
        SECTIONS.forEach((sec, idx) => {
          const total = sec.questions.length;
          const card = document.createElement("div");
          card.className = "sec-card";
          const left = document.createElement("div");
          left.className = "sec-left";
          const title = document.createElement("div");
          title.className = "sec-title";
          title.textContent = sec.title;
          const meta = document.createElement("div");
          meta.className = "sec-meta";
          meta.textContent = `عدد الأسئلة: ${total}`;
          left.appendChild(title);
          left.appendChild(meta);

          const start = document.createElement("button");
          start.className = "start-btn";
          start.textContent = "ابدأ هذا القسم";
          start.onclick = () => startSection(idx);

          card.appendChild(left);
          card.appendChild(start);
          secList.appendChild(card);
        });
      }

      /* انطلاق */
      renderSectionsList();
      updateGlobal();
    </script>
  </body>
</html>
